<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Color Rush: TV vs Android</title>
    
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <style>
        :root {
            --bg-color: #1a1a2e;
            --text-color: #ffffff;
            --accent: #e94560;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            overflow: hidden;
            text-align: center;
        }
        h1, h2, h3 { margin: 10px; }
        
        /* Utility Classes */
        .hidden { display: none !important; }
        .flex { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; }
        
        /* Screens */
        #setup-screen, #host-screen, #client-screen, #game-ui-host, #game-ui-client {
            width: 100%;
            max-width: 800px;
            padding: 20px;
        }

        /* QR Code Area */
        #qrcode {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin: 20px auto;
            width: fit-content;
        }

        /* Color Blocks */
        .color-display {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin: 20px 0;
            min-height: 80px;
        }
        .color-box {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 0 15px rgba(0,0,0,0.5);
        }

        /* Controller Buttons */
        .btn-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            padding: 10px;
        }
        .color-btn {
            height: 80px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: transform 0.1s;
        }
        .color-btn:active { transform: scale(0.95); }

        /* Colors */
        .c-red { background-color: #ff4757; }
        .c-green { background-color: #2ed573; }
        .c-blue { background-color: #1e90ff; }
        .c-yellow { background-color: #ffa502; }
        .c-purple { background-color: #8e44ad; }
        .c-orange { background-color: #e67e22; }
        .c-cyan { background-color: #00d2d3; }

        /* Status & Timer */
        #countdown { font-size: 5rem; font-weight: bold; color: var(--accent); }
        .player-status { padding: 10px; background: rgba(255,255,255,0.1); border-radius: 8px; margin: 5px; }
        .winner-text { font-size: 3rem; color: #2ed573; animation: blink 1s infinite; }

        @keyframes blink { 50% { opacity: 0.5; } }
    </style>
</head>
<body>

    <div id="setup-screen">
        <h1>Color Rush</h1>
        <p>Pilih peran perangkat ini:</p>
        <button onclick="initHost()" style="padding: 15px 30px; font-size: 1.2rem; cursor: pointer;">ðŸ“º Mode TV (Host)</button>
        <p><small>Gunakan HP untuk scan QR nanti.</small></p>
    </div>

    <div id="host-lobby" class="hidden">
        <h2>Scan untuk Join</h2>
        <div id="qrcode"></div>
        <div class="flex">
            <div id="p1-status" class="player-status">Player 1: Menunggu...</div>
            <div id="p2-status" class="player-status">Player 2: Menunggu...</div>
        </div>
        <h3 id="lobby-msg">Menunggu 2 pemain...</h3>
    </div>

    <div id="host-game" class="hidden">
        <h2>Level <span id="level-indicator">1</span></h2>
        <div id="countdown" class="hidden">3</div>
        
        <div id="sequence-display" class="color-display"></div>
        
        <h3 id="game-status-text">Hafalkan warnanya!</h3>
    </div>

    <div id="client-screen" class="hidden">
        <h2 id="player-id-disp">Player</h2>
        <div id="client-msg" style="font-size: 1.5rem; margin: 20px;">Menunggu Host...</div>
        
        <div id="input-area" class="hidden">
            <p>Urutkan warnanya!</p>
            <div class="color-display" id="my-input-display" style="justify-content: flex-start; overflow-x: auto; padding: 5px;"></div>
            <div class="btn-grid">
                <button class="color-btn c-red" onclick="inputColor('red')"></button>
                <button class="color-btn c-green" onclick="inputColor('green')"></button>
                <button class="color-btn c-blue" onclick="inputColor('blue')"></button>
                <button class="color-btn c-yellow" onclick="inputColor('yellow')"></button>
                <button class="color-btn c-purple" onclick="inputColor('purple')"></button>
                <button class="color-btn c-orange" onclick="inputColor('orange')"></button>
                <button class="color-btn c-cyan" onclick="inputColor('cyan')"></button>
                <button class="color-btn" style="background:#555" onclick="resetInput()">RESET</button>
            </div>
        </div>
    </div>

    <script>
        // --- KONFIGURASI ---
        const COLORS = ['red', 'green', 'blue', 'yellow', 'purple', 'orange', 'cyan'];
        const PEER_PREFIX = 'color-rush-game-';
        
        // State Global
        let myPeer = null;
        let connections = []; // Untuk Host
        let hostConn = null;  // Untuk Client
        let gameLevel = 1;
        let targetSequence = [];
        let playerInput = [];
        let isHost = false;
        let myPlayerNum = 0;

        // --- INISIALISASI ---
        const urlParams = new URLSearchParams(window.location.search);
        const hostIdParam = urlParams.get('host');

        if (hostIdParam) {
            // Jika ada parameter host, otomatis jadi CLIENT (Android)
            initClient(hostIdParam);
        }

        // --- LOGIKA HOST (TV) ---
        function initHost() {
            isHost = true;
            document.getElementById('setup-screen').classList.add('hidden');
            document.getElementById('host-lobby').classList.remove('hidden');

            const id = PEER_PREFIX + generateShortId();
            myPeer = new Peer(id);

            myPeer.on('open', (id) => {
                console.log('Host ID:', id);
                // Generate QR Code
                const gameUrl = `${window.location.href.split('?')[0]}?host=${id}`;
                new QRCode(document.getElementById("qrcode"), {
                    text: gameUrl,
                    width: 256,
                    height: 256
                });
            });

            myPeer.on('connection', (conn) => {
                if (connections.length >= 2) {
                    conn.send({type: 'FULL'});
                    setTimeout(() => conn.close(), 1000);
                    return;
                }

                connections.push(conn);
                const pNum = connections.length;
                
                setupHostConnection(conn, pNum);
            });
        }

        function setupHostConnection(conn, pNum) {
            conn.on('open', () => {
                document.getElementById(`p${pNum}-status`).innerText = `Player ${pNum}: TERHUBUNG`;
                document.getElementById(`p${pNum}-status`).style.background = '#2ed573';
                
                conn.send({ type: 'WELCOME', player: pNum });

                if (connections.length === 2) {
                    document.getElementById('lobby-msg').innerText = "Semua pemain siap! Mulai dalam 3 detik...";
                    setTimeout(startGameLoop, 3000);
                }
            });

            conn.on('data', (data) => {
                if (data.type === 'SUBMIT_SEQUENCE') {
                    checkWinner(pNum, data.sequence);
                }
            });

            conn.on('close', () => {
                alert(`Player ${pNum} terputus. Refresh untuk ulang.`);
                location.reload();
            });
        }

        // --- GAME LOOP (HOST) ---
        function startGameLoop() {
            document.getElementById('host-lobby').classList.add('hidden');
            document.getElementById('host-game').classList.remove('hidden');
            startLevel(1);
        }

        function startLevel(lvl) {
            gameLevel = lvl;
            document.getElementById('level-indicator').innerText = gameLevel;
            document.getElementById('sequence-display').innerHTML = '';
            document.getElementById('game-status-text').innerText = "Bersiap...";
            
            // Generate Sequence (Panjang = Level + 2)
            targetSequence = [];
            for(let i=0; i < (gameLevel + 2); i++) {
                targetSequence.push(COLORS[Math.floor(Math.random() * COLORS.length)]);
            }

            // Broadcast Reset
            broadcast({ type: 'RESET_ROUND', level: gameLevel });

            // Countdown
            let count = 3;
            const cdEl = document.getElementById('countdown');
            cdEl.classList.remove('hidden');
            
            const cdInterval = setInterval(() => {
                cdEl.innerText = count;
                if(count <= 0) {
                    clearInterval(cdInterval);
                    cdEl.classList.add('hidden');
                    showSequenceOnTV();
                }
                count--;
            }, 1000);
        }

        function showSequenceOnTV() {
            const container = document.getElementById('sequence-display');
            container.innerHTML = '';
            
            // Tampilkan warna satu per satu atau sekaligus? 
            // Sesuai request: "Menampilkan urutan warna"
            targetSequence.forEach(color => {
                const div = document.createElement('div');
                div.className = `color-box c-${color}`;
                container.appendChild(div);
            });

            document.getElementById('game-status-text').innerText = "Hafalkan!";
            
            // Setelah 5 detik (atau dinamis), sembunyikan dan mulai input
            setTimeout(() => {
                container.innerHTML = '<h2 style="font-size:3rem">GO!</h2>'; // Sembunyikan warna
                document.getElementById('game-status-text').innerText = "Ayo Susun di HP!";
                broadcast({ type: 'START_INPUT', length: targetSequence.length });
            }, 2000 + (gameLevel * 500)); // Waktu tampil makin lama jika level tinggi
        }

        function checkWinner(playerNum, sequence) {
            // Cek kebenaran
            if (JSON.stringify(sequence) === JSON.stringify(targetSequence)) {
                // WINNER
                document.getElementById('game-status-text').innerHTML = `<span class="winner-text">PLAYER ${playerNum} MENANG!</span>`;
                broadcast({ type: 'GAME_OVER', winner: playerNum });
                
                setTimeout(() => {
                    if (gameLevel < 10) {
                        startLevel(gameLevel + 1);
                    } else {
                        document.getElementById('game-status-text').innerText = "GAME TAMAT! Pemenang Akhir ditentukan.";
                    }
                }, 4000);
            } else {
                // Salah urutan (opsional: beri penalti atau biarkan lanjut)
                // Disini kita abaikan saja sampai ada yang benar
            }
        }

        function broadcast(data) {
            connections.forEach(c => c.send(data));
        }

        // --- LOGIKA CLIENT (ANDROID) ---
        function initClient(hostId) {
            document.getElementById('setup-screen').classList.add('hidden');
            document.getElementById('client-screen').classList.remove('hidden');

            const myId = PEER_PREFIX + generateShortId();
            myPeer = new Peer(myId);

            myPeer.on('open', () => {
                hostConn = myPeer.connect(hostId);
                
                hostConn.on('open', () => {
                    document.getElementById('client-msg').innerText = "Terhubung! Menunggu Host...";
                });

                hostConn.on('data', handleClientData);
                
                hostConn.on('close', () => {
                    alert("Koneksi ke TV terputus.");
                });
            });
        }

        function handleClientData(data) {
            const msgEl = document.getElementById('client-msg');
            const inputArea = document.getElementById('input-area');

            if (data.type === 'WELCOME') {
                myPlayerNum = data.player;
                document.getElementById('player-id-disp').innerText = `Anda PLAYER ${myPlayerNum}`;
                document.body.style.border = myPlayerNum === 1 ? "5px solid cyan" : "5px solid orange";
            }
            else if (data.type === 'RESET_ROUND') {
                inputArea.classList.add('hidden');
                msgEl.classList.remove('hidden');
                msgEl.innerText = `Level ${data.level}. Perhatikan TV!`;
                playerInput = [];
                updateInputDisplay();
            }
            else if (data.type === 'START_INPUT') {
                msgEl.classList.add('hidden');
                inputArea.classList.remove('hidden');
                // Simpan target length untuk validasi
                inputArea.dataset.length = data.length;
            }
            else if (data.type === 'GAME_OVER') {
                inputArea.classList.add('hidden');
                msgEl.classList.remove('hidden');
                if (data.winner === myPlayerNum) {
                    msgEl.innerText = "ðŸ† KAMU MENANG! ðŸ†";
                    document.body.style.backgroundColor = "#2ed573";
                } else {
                    msgEl.innerText = "âŒ KAMU KALAH!";
                    document.body.style.backgroundColor = "#ff4757";
                }
                setTimeout(() => {
                    document.body.style.backgroundColor = ""; // Reset bg
                }, 3000);
            }
        }

        // Fungsi Input Player
        function inputColor(color) {
            const maxLen = parseInt(document.getElementById('input-area').dataset.length || 0);
            if (playerInput.length >= maxLen) return;

            playerInput.push(color);
            updateInputDisplay();

            // Auto submit jika panjang sudah pas
            if (playerInput.length === maxLen) {
                hostConn.send({ type: 'SUBMIT_SEQUENCE', sequence: playerInput });
            }
        }

        function resetInput() {
            playerInput = [];
            updateInputDisplay();
        }

        function updateInputDisplay() {
            const disp = document.getElementById('my-input-display');
            disp.innerHTML = '';
            playerInput.forEach(c => {
                const div = document.createElement('div');
                div.className = `color-box c-${c}`;
                div.style.width = '40px'; 
                div.style.height = '40px';
                disp.appendChild(div);
            });
        }

        // --- UTILS ---
        function generateShortId() {
            return Math.random().toString(36).substr(2, 6);
        }
    </script>
</body>
</html>
