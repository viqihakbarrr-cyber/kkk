<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Neon Karaoke - Fast Mode</title>
    
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">

    <style>
        :root { --primary: #00f2ff; --secondary: #ff0055; --bg: #0f0c29; --text: #fff; }
        body { font-family: 'Poppins', sans-serif; background: var(--bg); color: var(--text); padding: 20px; text-align: center; }
        .card { background: rgba(255,255,255,0.1); padding: 20px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.2); margin: 10px auto; max-width: 400px; }
        .btn { background: linear-gradient(90deg, var(--secondary), #ff4b1f); color: white; border: none; padding: 15px; width: 100%; border-radius: 50px; font-weight: bold; margin-top: 10px; cursor: pointer; }
        .hidden { display: none; }
        .switch-box { display: flex; align-items: center; justify-content: space-between; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 10px; margin-bottom: 10px; }
        input[type=checkbox] { transform: scale(1.5); }
        .warning { font-size: 0.8rem; color: #ffcc00; margin-bottom: 15px; border: 1px solid #ffcc00; padding: 10px; border-radius: 8px; }
    </style>
</head>
<body>

    <h2>⚡ NEON FAST LINK</h2>

    <div id="menu-screen" class="card">
        <div class="warning">
            <i class="fas fa-exclamation-triangle"></i> <b>Trik Kurangi Delay:</b><br>
            1. Di Remote TV, cari "Sound Mode", pilih <b>"Game"</b> atau <b>"Sport"</b> (Matikan Dolby/Surround).<br>
            2. Matikan Bluetooth di HP (Bikin lemot WiFi).
        </div>
        <button onclick="startTVMode()" class="btn"><i class="fas fa-tv"></i> MODE TV (SPEAKER)</button>
        <button onclick="startMicMode()" class="btn" style="background:#333"><i class="fas fa-microphone"></i> MODE HP (MIC)</button>
    </div>

    <div id="tv-screen" class="card hidden">
        <h3>Scan di HP:</h3>
        <div id="qr-container" style="background: white; padding: 10px; display:inline-block; border-radius:10px;"></div>
        <p id="tv-status">Menunggu Koneksi...</p>
        <audio id="remote-audio" autoplay></audio>
    </div>

    <div id="mic-screen" class="card hidden">
        <div id="scanner-area">
            <div id="reader" style="width:100%"></div>
        </div>

        <div id="mic-controls" class="hidden">
            <h3 style="color: #00ff88">MIC ON 當</h3>
            
            <div class="switch-box">
                <span><b>Mode Ultra Cepat</b><br><small>Matikan Echo (Suara Kering)</small></span>
                <input type="checkbox" id="fast-mode" checked onchange="toggleMode()">
            </div>

            <div class="switch-box" id="echo-box" style="opacity: 0.5; pointer-events: none;">
                <span>Volume Echo</span>
                <input type="range" id="echo-amt" min="0" max="0.8" step="0.1" value="0.3">
            </div>

            <button onclick="location.reload()" class="btn" style="background: #444">Putus Koneksi</button>
        </div>
    </div>

    <script>
        const peerConfig = { debug: 0 }; 
        let peer, conn, localStream, audioContext;
        let gainNode, delayNode;

        // --- TV MODE ---
        function startTVMode() {
            document.getElementById('menu-screen').classList.add('hidden');
            document.getElementById('tv-screen').classList.remove('hidden');
            
            peer = new Peer("tv-" + Math.floor(Math.random()*9999), peerConfig);
            
            peer.on('open', id => {
                new QRCode(document.getElementById("qr-container"), { text: id, width: 150, height: 150 });
            });

            peer.on('call', call => {
                call.answer();
                document.getElementById('tv-status').innerText = "TERHUBUNG! 當";
                // Trik TV: Paksa play instant
                call.on('stream', stream => {
                    const audio = document.getElementById('remote-audio');
                    audio.srcObject = stream;
                    audio.play();
                });
            });
        }

        // --- MIC MODE ---
        function startMicMode() {
            document.getElementById('menu-screen').classList.add('hidden');
            document.getElementById('mic-screen').classList.remove('hidden');
            
            const html5QrCode = new Html5Qrcode("reader");
            html5QrCode.start({ facingMode: "environment" }, { fps: 10 }, (id) => {
                html5QrCode.stop();
                document.getElementById('scanner-area').classList.add('hidden');
                connectMic(id);
            });
        }

        function toggleMode() {
            // Refresh stream logic based on checkbox
            alert("Ubah mode perlu reconnect. Tekan OK.");
            location.reload();
        }

        async function connectMic(tvId) {
            document.getElementById('mic-controls').classList.remove('hidden');
            peer = new Peer(peerConfig);
            
            const isFastMode = document.getElementById('fast-mode').checked;

            peer.on('open', async () => {
                // SETTINGAN AGRESIF UNTUK SPEED
                const constraints = {
                    audio: {
                        echoCancellation: false, // MATIKAN PROSESING HP
                        noiseSuppression: false,
                        autoGainControl: false,
                        latency: 0,
                        channelCount: 1, // MONO LEBIH RINGAN
                        sampleRate: 44100
                    }
                };

                try {
                    const stream = await navigator.mediaDevices.getUserMedia(constraints);
                    
                    if (isFastMode) {
                        // JALUR TOL: Kirim Stream Mentah (Paling Cepat)
                        peer.call(tvId, stream);
                    } else {
                        // JALUR ECHO: Lewat AudioContext (Ada sedikit delay)
                        const processedStream = addEcho(stream);
                        peer.call(tvId, processedStream);
                    }

                } catch(e) { alert("Mic Error: " + e); }
            });
        }

        function addEcho(rawStream) {
            const AudioCtx = window.AudioContext || window.webkitAudioContext;
            // latencyHint 0 memaksa browser memprioritaskan speed daripada kualitas
            audioContext = new AudioCtx({ latencyHint: 0 }); 
            
            const source = audioContext.createMediaStreamSource(rawStream);
            const dest = audioContext.createMediaStreamDestination();
            
            const delay = audioContext.createDelay();
            delay.delayTime.value = 0.2;
            
            const feedback = audioContext.createGain();
            feedback.gain.value = 0.3;
            
            const masterVol = audioContext.createGain();

            // Wiring Audio:
            source.connect(masterVol);     // Suara asli
            source.connect(delay);         // Masuk delay
            delay.connect(feedback);       // Feedback loop
            feedback.connect(delay);       
            delay.connect(masterVol);      // Output delay
            
            masterVol.connect(dest);

            return dest.stream;
        }
    </script>
</body>
</html>
