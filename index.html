<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Neon Karaoke - Realtime Kernel</title>
    
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <style>
        :root {
            --primary: #00f2ff;
            --secondary: #ff0055;
            --bg-dark: #0f0c29;
            --glass: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.2);
            --text: #ffffff;
        }

        * { box-sizing: border-box; touch-action: manipulation; }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
            color: var(--text);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            overflow-x: hidden;
        }

        .app-title {
            font-size: 2.2rem;
            font-weight: 800;
            margin-bottom: 5px;
            background: linear-gradient(to right, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 20px rgba(0, 242, 255, 0.3);
        }

        .card {
            background: var(--glass);
            backdrop-filter: blur(16px);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            padding: 25px;
            width: 100%;
            max-width: 480px;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
            margin-bottom: 20px;
        }

        .btn {
            background: linear-gradient(90deg, var(--secondary), #ff4b1f);
            color: white;
            border: none;
            padding: 16px;
            font-size: 1rem;
            font-weight: 600;
            border-radius: 50px;
            cursor: pointer;
            width: 100%;
            margin: 8px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            box-shadow: 0 4px 15px rgba(255, 0, 85, 0.4);
        }
        .btn:active { transform: scale(0.96); }
        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            box-shadow: none;
            border: 1px solid var(--glass-border);
        }

        .hidden { display: none !important; }

        .info-box {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 12px;
            font-size: 0.85rem;
            margin-bottom: 20px;
            border-left: 4px solid var(--primary);
        }

        /* Controls */
        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            background: transparent;
            margin: 10px 0;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 20px;
            width: 20px;
            border-radius: 50%;
            background: var(--primary);
            margin-top: -8px;
            box-shadow: 0 0 10px var(--primary);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            background: rgba(255,255,255,0.2);
            border-radius: 2px;
        }

        #visualizer {
            width: 100%;
            height: 60px;
            background: rgba(0,0,0,0.2);
            border-radius: 10px;
            margin-bottom: 20px;
        }

        #qr-container {
            background: white;
            padding: 10px;
            border-radius: 10px;
            margin: 10px auto;
            width: fit-content;
        }
        
        #reader {
            width: 100%;
            border-radius: 15px;
            overflow: hidden;
            border: 2px solid var(--primary);
        }

        .latency-stat {
            font-family: monospace;
            color: #00ff88;
            font-size: 0.8rem;
            text-align: center;
            margin-top: 5px;
        }
    </style>
</head>
<body>

    <div style="text-align: center;">
        <i class="fas fa-bolt fa-2x" style="color:var(--primary); margin-bottom:5px;"></i>
        <div class="app-title">NEON REALTIME</div>
        <div style="font-size: 0.8rem; opacity: 0.7; margin-bottom: 20px;">Zero-Latency Optimized Architecture</div>
    </div>

    <div id="menu-screen" class="card">
        <div class="info-box">
            <strong>ðŸš€ Mode Turbo Aktif</strong><br>
            Sistem ini menggunakan bypass buffer audio dan pemrosesan stream raw mono untuk latensi mendekati nol.
        </div>
        <button onclick="startTVMode()" class="btn">
            <i class="fas fa-tv"></i> MODE SPEAKER (TV/PC)
        </button>
        <button onclick="startMicMode()" class="btn btn-secondary">
            <i class="fas fa-microphone"></i> MODE MIC (HP)
        </button>
    </div>

    <div id="tv-screen" class="card hidden">
        <h3 style="text-align:center; margin-top:0;">Scan untuk Connect</h3>
        <div id="qr-container"></div>
        <div class="latency-stat" id="connection-status">Menunggu Mic...</div>

        <canvas id="visualizer"></canvas>

        <div class="info-box" style="margin-top: 15px;">
            <i class="fas fa-sliders-h"></i> <strong>Mixer (Kontrol di Sini)</strong>
            <br><small>Efek diproses di TV untuk meringankan beban HP</small>
        </div>

        <div class="control-group">
            <div style="display:flex; justify-content:space-between; font-size:0.9rem;">
                <span>Volume Mic</span> <span id="vol-disp">100%</span>
            </div>
            <input type="range" id="tv-vol" min="0" max="2" step="0.1" value="1">
        </div>

        <div class="control-group">
            <div style="display:flex; justify-content:space-between; font-size:0.9rem;">
                <span>Echo Delay</span> <span id="echo-disp">150ms</span>
            </div>
            <input type="range" id="tv-echo" min="0" max="0.5" step="0.01" value="0.15">
        </div>

        <div class="control-group">
            <div style="display:flex; justify-content:space-between; font-size:0.9rem;">
                <span>Echo Feedback</span> <span id="feed-disp">30%</span>
            </div>
            <input type="range" id="tv-feed" min="0" max="0.8" step="0.05" value="0.3">
        </div>

        <button onclick="location.reload()" class="btn btn-secondary" style="margin-top:20px;">
            <i class="fas fa-power-off"></i> Reset Sistem
        </button>
    </div>

    <div id="mic-screen" class="card hidden">
        <div id="scan-area">
            <h3 style="text-align:center;">Scan QR di TV</h3>
            <div id="reader"></div>
            <button onclick="location.reload()" class="btn btn-secondary" style="margin-top:15px;">Batal</button>
        </div>

        <div id="mic-active" class="hidden" style="text-align: center;">
            <div style="width: 80px; height: 80px; background: rgba(0,255,0,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px auto; border: 2px solid #00ff88; animation: pulse 2s infinite;">
                <i class="fas fa-microphone fa-2x" style="color: #00ff88;"></i>
            </div>
            <h3>MIC AKTIF</h3>
            <p style="font-size: 0.9rem; opacity: 0.8;">
                Audio sedang dikirim ke TV.<br>
                <small>Jaga layar tetap menyala.</small>
            </p>
            <button onclick="location.reload()" class="btn" style="background: #333; margin-top: 30px;">
                Matikan
            </button>
        </div>
    </div>

    <script>
        // --- KONFIGURASI ZERO LATENCY ---
        // Kita menggunakan Google STUN saja untuk kecepatan handshake.
        const peerConfig = {
            debug: 0,
            config: { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] }
        };

        // --- GLOBAL VARIABLES ---
        let peer = null;
        let audioCtx = null;
        let analyser = null;
        
        // --- HELPER UI ---
        const show = (id) => {
            document.querySelectorAll('.card').forEach(e => e.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
        };

        // ==========================================
        // TV LOGIC (PENERIMA & PROCESSOR)
        // ==========================================
        function startTVMode() {
            show('tv-screen');
            // Init Audio Context segera (harus di-trigger user interaction, tombol startTVMode sudah cukup)
            initAudioContext();
            
            const peerId = "neon-" + Math.floor(Math.random() * 9999);
            peer = new Peer(peerId, peerConfig);

            peer.on('open', (id) => {
                new QRCode(document.getElementById("qr-container"), {
                    text: id, width: 160, height: 160
                });
            });

            peer.on('call', (call) => {
                document.getElementById('connection-status').innerHTML = "CONNECTED <i class='fas fa-check-circle'></i>";
                document.getElementById('qr-container').style.display = 'none';
                
                call.answer(); // Jawab tanpa stream balik (One-way audio)
                
                call.on('stream', (remoteStream) => {
                    handleRemoteStream(remoteStream);
                });
            });
        }

        // Processing Audio di sisi Penerima (TV) untuk mengurangi beban HP
        function initAudioContext() {
            // LatencyHint 'interactive' adalah kunci untuk realtime di WebAudio
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            audioCtx = new AudioContext({ 
                latencyHint: 'interactive', 
                sampleRate: 48000 
            });
        }

        function handleRemoteStream(stream) {
            if (audioCtx.state === 'suspended') audioCtx.resume();

            // BYPASS: Jangan gunakan <audio> tag HTML. Langsung masuk ke WebAudio Graph.
            const source = audioCtx.createMediaStreamSource(stream);
            
            // Nodes
            const gainNode = audioCtx.createGain(); // Volume
            const delayNode = audioCtx.createDelay(1.0); // Echo Delay
            const feedbackNode = audioCtx.createGain(); // Echo Repeat
            const masterComp = audioCtx.createDynamicsCompressor(); // Limiter agar tidak pecah
            analyser = audioCtx.createAnalyser();

            // Setup Nodes Values
            gainNode.gain.value = 1.0;
            delayNode.delayTime.value = 0.15;
            feedbackNode.gain.value = 0.3;
            analyser.fftSize = 128;

            // WIRING (Routing Audio)
            // Jalur 1: Suara Asli (Dry) -> Output
            source.connect(gainNode);
            gainNode.connect(masterComp);
            
            // Jalur 2: Echo (Wet)
            gainNode.connect(delayNode);
            delayNode.connect(feedbackNode);
            feedbackNode.connect(delayNode); // Loop feedback
            delayNode.connect(masterComp);   // Mix echo ke output

            // Final Output
            masterComp.connect(analyser);
            masterComp.connect(audioCtx.destination);

            // Mulai Visualizer
            drawVisualizer();

            // Binding Controls TV
            bindControl('tv-vol', (v) => { 
                gainNode.gain.value = v; 
                document.getElementById('vol-disp').innerText = Math.round(v*100)+'%';
            });
            bindControl('tv-echo', (v) => { 
                delayNode.delayTime.value = v; 
                document.getElementById('echo-disp').innerText = Math.round(v*1000)+'ms';
            });
            bindControl('tv-feed', (v) => { 
                feedbackNode.gain.value = v; 
                document.getElementById('feed-disp').innerText = Math.round(v*100)+'%';
            });
        }

        function bindControl(id, callback) {
            document.getElementById(id).addEventListener('input', (e) => callback(parseFloat(e.target.value)));
        }

        // ==========================================
        // MIC LOGIC (PENGIRIM RAW)
        // ==========================================
        function startMicMode() {
            show('mic-screen');
            const html5QrCode = new Html5Qrcode("reader");
            html5QrCode.start(
                { facingMode: "environment" }, 
                { fps: 15, qrbox: 250 },
                (decodedText) => {
                    html5QrCode.stop();
                    connectToTV(decodedText);
                },
                () => {}
            );
        }

        async function connectToTV(peerId) {
            document.getElementById('scan-area').classList.add('hidden');
            document.getElementById('mic-active').classList.remove('hidden');

            peer = new Peer(peerConfig);

            peer.on('open', async () => {
                try {
                    // --- CONSTRAINT SANGAT KRUSIAL UNTUK DELAY ---
                    // Matikan semua processing software di HP.
                    // Channel 1 (Mono) = Lebih sedikit data = Lebih cepat dikirim.
                    const stream = await navigator.mediaDevices.getUserMedia({
                        audio: {
                            echoCancellation: false,
                            noiseSuppression: false,
                            autoGainControl: false,
                            latency: 0,
                            channelCount: 1, 
                            sampleRate: 48000
                        },
                        video: false
                    });

                    // Kirim stream mentah langsung via PeerJS
                    // Kita tidak memproses audio di HP sama sekali untuk hemat CPU & Waktu
                    const call = peer.call(peerId, stream);

                    // Keep alive hack untuk mobile browser agar tidak sleep
                    const dummyAudio = document.createElement('audio');
                    dummyAudio.srcObject = stream;
                    dummyAudio.muted = true;
                    dummyAudio.play();

                } catch (err) {
                    alert("Error Mic: " + err);
                    location.reload();
                }
            });
        }

        // ==========================================
        // VISUALIZER (Ringan)
        // ==========================================
        function drawVisualizer() {
            if (!analyser) return;
            const canvas = document.getElementById('visualizer');
            const ctx = canvas.getContext('2d');
            const bufferLength = analyser.frequencyBinCount;
            const dataArray = new Uint8Array(bufferLength);

            function render() {
                requestAnimationFrame(render);
                analyser.getByteFrequencyData(dataArray);
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                const barWidth = (canvas.width / bufferLength) * 2.5;
                let x = 0;

                for (let i = 0; i < bufferLength; i++) {
                    const barHeight = (dataArray[i] / 255) * canvas.height;
                    ctx.fillStyle = `rgb(${barHeight + 100}, 50, 200)`;
                    ctx.fillRect(x, canvas.height - barHeight, barWidth, barHeight);
                    x += barWidth + 1;
                }
            }
            render();
        }

        // CSS Animation Pulse
        const styleSheet = document.createElement("style");
        styleSheet.innerText = `
            @keyframes pulse {
                0% { box-shadow: 0 0 0 0 rgba(0, 255, 136, 0.4); }
                70% { box-shadow: 0 0 0 20px rgba(0, 255, 136, 0); }
                100% { box-shadow: 0 0 0 0 rgba(0, 255, 136, 0); }
            }
        `;
        document.head.appendChild(styleSheet);
    </script>
</body>
</html>
