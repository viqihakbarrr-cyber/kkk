<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebRTC Low Latency Karaoke</title>
    
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <style>
        :root {
            --primary: #ff0055;
            --dark: #121212;
            --surface: #1e1e1e;
            --text: #ffffff;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--dark);
            color: var(--text);
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            text-align: center;
            overflow-x: hidden;
        }
        h1 { margin-bottom: 5px; color: var(--primary); }
        p { color: #aaa; margin-bottom: 20px; }
        
        /* Container Setup */
        .screen { display: none; width: 100%; max-width: 600px; padding: 20px; box-sizing: border-box; }
        .active { display: flex; flex-direction: column; align-items: center; }

        /* Buttons */
        .btn-big {
            width: 100%;
            padding: 20px;
            margin: 10px 0;
            font-size: 1.2rem;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: bold;
            transition: transform 0.1s;
        }
        .btn-tv { background: #2196F3; color: white; }
        .btn-mic { background: #4CAF50; color: white; }
        .btn-big:active { transform: scale(0.98); }

        /* Controls */
        .control-group {
            width: 100%;
            background: var(--surface);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            text-align: left;
        }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input[type=range] { width: 100%; accent-color: var(--primary); }

        /* QR & Video */
        #qrcode { background: white; padding: 10px; border-radius: 8px; margin: 20px 0; }
        #reader { width: 100%; border-radius: 10px; overflow: hidden; background: #000; }
        
        /* Visualizer */
        canvas { width: 100%; height: 100px; background: #000; border-radius: 8px; margin-top: 10px; }

        .status {
            padding: 10px;
            border-radius: 5px;
            background: #333;
            margin-bottom: 15px;
            font-size: 0.9rem;
        }
        .status.connected { background: #1b5e20; color: #fff; }
    </style>
</head>
<body>

    <div id="home-screen" class="screen active">
        <h1>ðŸŽ¤ Web Karaoke P2P</h1>
        <p>Pilih peran perangkat ini</p>
        <button class="btn-big btn-tv" onclick="initTV()">ðŸ“º Mode TV (Layar & Speaker)</button>
        <button class="btn-big btn-mic" onclick="initMic()">ðŸ“± Mode Mic (Android)</button>
        <p style="font-size: 0.8rem; color: #666; margin-top: 20px;">Wajib menggunakan HTTPS agar Mic berfungsi.</p>
    </div>

    <div id="tv-screen" class="screen">
        <h1>ðŸ“º TV Mode</h1>
        <div id="tv-status" class="status">Menyiapkan koneksi...</div>
        
        <div id="qrcode"></div>
        <p id="tv-instruction">Scan QR ini dengan HP Android</p>

        <div class="control-group">
            <label>Master Volume: <span id="vol-val">100%</span></label>
            <input type="range" id="volume" min="0" max="2" step="0.1" value="1" oninput="updateAudio()">
        </div>
        
        <div class="control-group">
            <label>Echo (Reverb): <span id="echo-val">30%</span></label>
            <input type="range" id="echo" min="0" max="1" step="0.1" value="0.3" oninput="updateAudio()">
        </div>

        <canvas id="visualizer"></canvas>
    </div>

    <div id="mic-screen" class="screen">
        <h1>ðŸ“± Mic Mode</h1>
        <div id="mic-status" class="status">Siapkan kamera...</div>
        
        <div id="reader"></div>

        <div id="mic-controls" style="display:none; width: 100%;">
            <div class="control-group" style="text-align: center;">
                <h2>ðŸŽ¤ Connected!</h2>
                <p>Bernyanyilah ke HP Anda.</p>
                <button class="btn-big" style="background: #d32f2f; color: white;" onclick="location.reload()">Putus / Keluar</button>
            </div>
        </div>
    </div>

<script>
    // --- VARIABEL GLOBAL ---
    let peer;
    let conn;
    let audioContext;
    let sourceNode, gainNode, convolverNode, wetGainNode, dryGainNode;
    let analyser;
    
    // Konfigurasi Delay Minim
    // Kita mematikan semua processing di HP agar sinyal dikirim mentah & cepat
    const audioConstraints = {
        audio: {
            echoCancellation: false, 
            autoGainControl: false,
            noiseSuppression: false,
            latency: 0
        },
        video: false
    };

    // --- NAVIGASI UI ---
    function showScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }

    // --- LOGIKA TV ---
    function initTV() {
        showScreen('tv-screen');
        
        // Inisialisasi Audio Context (Browser butuh interaksi user dulu, tombol klik tadi sudah cukup)
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        audioContext = new AudioContext({ latencyHint: 'interactive' }); // KUNCI: latencyHint interactive

        // Buat ID Peer Random
        peer = new Peer(null, { debug: 2 });

        peer.on('open', (id) => {
            console.log('My peer ID is: ' + id);
            document.getElementById('tv-status').innerText = "Menunggu scan dari HP...";
            
            // Generate QR Code
            new QRCode(document.getElementById("qrcode"), {
                text: id,
                width: 200,
                height: 200
            });
        });

        // Saat menerima panggilan (Stream Suara)
        peer.on('call', (call) => {
            console.log("Menerima panggilan...");
            document.getElementById('tv-status').className = "status connected";
            document.getElementById('tv-status').innerText = "Terhubung dengan Mic!";
            document.getElementById('qrcode').style.display = 'none';
            document.getElementById('tv-instruction').style.display = 'none';

            call.answer(); // Jawab tanpa stream balik (one-way)
            
            call.on('stream', (remoteStream) => {
                setupTvAudio(remoteStream);
            });
        });
    }

    // --- LOGIKA MIC (ANDROID) ---
    function initMic() {
        showScreen('mic-screen');
        
        // Setup Scanner
        const html5QrCode = new Html5Qrcode("reader");
        const config = { fps: 10, qrbox: { width: 250, height: 250 } };
        
        html5QrCode.start({ facingMode: "environment" }, config, (decodedText) => {
            // Sukses Scan
            html5QrCode.stop();
            document.getElementById('reader').style.display = 'none';
            connectToTV(decodedText);
        }, (errorMessage) => {
            // Scanning...
        }).catch(err => {
            document.getElementById('mic-status').innerText = "Gagal akses kamera: " + err;
        });
    }

    function connectToTV(tvId) {
        document.getElementById('mic-status').innerText = "Menghubungkan ke TV...";
        
        peer = new Peer(null, { debug: 2 });

        peer.on('open', async (id) => {
            try {
                // Ambil Mic Stream
                const stream = await navigator.mediaDevices.getUserMedia(audioConstraints);
                
                // Panggil TV
                const call = peer.call(tvId, stream);
                
                call.on('close', () => {
                    alert("Koneksi terputus");
                    location.reload();
                });

                document.getElementById('mic-status').className = "status connected";
                document.getElementById('mic-status').innerText = "Terhubung! Mulai bernyanyi.";
                document.getElementById('mic-controls').style.display = 'block';

            } catch (err) {
                alert("Gagal akses Mic: " + err.message + "\nPastikan menggunakan HTTPS!");
            }
        });

        peer.on('error', (err) => {
            alert("Error Koneksi: " + err.type);
        });
    }

    // --- AUDIO PROCESSING & VISUALIZER (TV SIDE) ---
    function setupTvAudio(stream) {
        // Setup Nodes
        sourceNode = audioContext.createMediaStreamSource(stream);
        
        // 1. Gain Node (Volume Master)
        gainNode = audioContext.createGain();
        
        // 2. Convolver (Untuk Echo/Reverb)
        convolverNode = audioContext.createConvolver();
        setReverbImpulse(convolverNode); // Buat efek gema sintetis
        
        // Routing untuk Efek
        dryGainNode = audioContext.createGain(); // Suara asli
        wetGainNode = audioContext.createGain(); // Suara gema
        
        // Source -> Dry -> Master -> Out
        sourceNode.connect(dryGainNode);
        dryGainNode.connect(gainNode);
        
        // Source -> Convolver -> Wet -> Master -> Out
        sourceNode.connect(convolverNode);
        convolverNode.connect(wetGainNode);
        wetGainNode.connect(gainNode);
        
        // Master -> Destination (Speaker)
        gainNode.connect(audioContext.destination);

        // Visualizer Setup
        analyser = audioContext.createAnalyser();
        gainNode.connect(analyser);
        analyser.fftSize = 256;
        drawVisualizer();

        // Apply setting awal
        updateAudio();
    }

    // Fungsi membuat Impulse Response (Gema Buatan)
    function setReverbImpulse(node) {
        const duration = 2.0;
        const decay = 2.0;
        const rate = audioContext.sampleRate;
        const length = rate * duration;
        const impulse = audioContext.createBuffer(2, length, rate);
        const left = impulse.getChannelData(0);
        const right = impulse.getChannelData(1);

        for (let i = 0; i < length; i++) {
            const n = length - i; // reverse index
            // Simple exponential decay noise
            left[i] = (Math.random() * 2 - 1) * Math.pow(1 - i / length, decay);
            right[i] = (Math.random() * 2 - 1) * Math.pow(1 - i / length, decay);
        }
        node.buffer = impulse;
    }

    function updateAudio() {
        if (!gainNode) return;
        
        const vol = parseFloat(document.getElementById('volume').value);
        const echo = parseFloat(document.getElementById('echo').value);

        // Volume Master
        gainNode.gain.setTargetAtTime(vol, audioContext.currentTime, 0.1);
        document.getElementById('vol-val').innerText = Math.round(vol * 100) + "%";

        // Echo Mixing (Dry/Wet)
        // Jika echo 0, Dry = 1, Wet = 0. Jika echo 1, Dry = 0.5, Wet = 1
        dryGainNode.gain.setTargetAtTime(1 - (echo * 0.4), audioContext.currentTime, 0.1); 
        wetGainNode.gain.setTargetAtTime(echo * 1.5, audioContext.currentTime, 0.1);
        
        document.getElementById('echo-val').innerText = Math.round(echo * 100) + "%";
    }

    function drawVisualizer() {
        requestAnimationFrame(drawVisualizer);
        const canvas = document.getElementById('visualizer');
        const ctx = canvas.getContext('2d');
        const bufferLength = analyser.frequencyBinCount;
        const dataArray = new Uint8Array(bufferLength);

        analyser.getByteFrequencyData(dataArray);

        ctx.fillStyle = '#000';
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        const barWidth = (canvas.width / bufferLength) * 2.5;
        let barHeight;
        let x = 0;

        for(let i = 0; i < bufferLength; i++) {
            barHeight = dataArray[i] / 2;
            ctx.fillStyle = `rgb(${barHeight + 100}, 50, 50)`;
            ctx.fillRect(x, canvas.height - barHeight, barWidth, barHeight);
            x += barWidth + 1;
        }
    }
</script>

</body>
</html>
